<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Samarth Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        background: #ffffff;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 90vh;
      }
      #chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .message {
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        max-width: 85%;
        line-height: 1.6;
      }
      .user-message {
        background-color: #f3f4f6; /* gray-100 */
        color: #1f2937; /* gray-800 */
        align-self: flex-end;
        border-bottom-right-radius: 0.25rem;
      }
      .bot-message {
        background-color: #4f46e5; /* indigo-600 */
        color: #ffffff;
        align-self: flex-start;
        border-bottom-left-radius: 0.25rem;
      }
      .bot-message strong {
        color: #c7d2fe; /* indigo-200 */
      }
      .citations {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #6366f1; /* indigo-500 */
        font-size: 0.8rem;
      }
      .citations-title {
        font-weight: bold;
        color: #e0e7ff; /* indigo-100 */
        margin-bottom: 0.5rem;
      }
      .citation-link {
        display: block;
        color: #ffffff;
        text-decoration: underline;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .citation-link:hover {
        color: #c7d2fe; /* indigo-200 */
      }
      .loading-dots {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem 1.25rem;
      }
      .loading-dots span {
        width: 10px;
        height: 10px;
        background-color: #c7d2fe; /* indigo-200 */
        border-radius: 50%;
        animation: bounce 1.4s infinite both;
      }
      .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      #chat-form {
        border-top: 1px solid #e5e7eb; /* gray-200 */
        padding: 1.5rem;
        display: flex;
        gap: 1rem;
        background: #f9fafb; /* gray-50 */
      }
      #chat-input {
        flex-grow: 1;
        border: 1px solid #d1d5db; /* gray-300 */
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 1rem;
      }
      #chat-input:focus {
        outline: none;
        border-color: #4f46e5; /* indigo-600 */
        box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
      }
      #send-button {
        background-color: #4f46e5; /* indigo-600 */
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #send-button:hover {
        background-color: #4338ca; /* indigo-700 */
      }
      #send-button:disabled {
        background-color: #a5b4fc; /* indigo-300 */
        cursor: not-allowed;
      }
      .sample-questions {
        padding: 0 1.5rem 1rem 1.5rem;
        background: #f9fafb; /* gray-50 */
        border-top: 1px solid #e5e7eb; /* gray-200 */
      }
      .sample-questions h4 {
        font-weight: 600;
        color: #374151; /* gray-700 */
        margin-bottom: 0.75rem;
      }
      .sample-questions button {
        font-size: 0.875rem;
        background: #e0e7ff; /* indigo-100 */
        color: #3730a3; /* indigo-800 */
        border: none;
        border-radius: 9999px;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .sample-questions button:hover {
        background: #c7d2fe; /* indigo-200 */
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="chat-container">
      <div class="p-6 border-b border-gray-200 bg-white">
        <h1 class="text-3xl font-bold text-gray-900">Project Samarth</h1>
        <p class="text-gray-600 mt-1">
          Intelligent Q&A for India's Agricultural & Climate Data
        </p>
      </div>

      <div id="chat-history">
        <!-- Chat messages will appear here -->
        <div class="message bot-message">
          Hello! I am Samarth. Ask me complex questions about India's
          agricultural economy and its relationship with climate patterns. I
          will source my answers live from <strong>data.gov.in</strong> and
          provide citations.
        </div>
      </div>

      <div class="sample-questions">
        <h4>Try a sample question:</h4>
        <div>
          <button onclick="trySample(this)">
            Compare annual rainfall in Maharashtra and Karnataka for the last 3
            available years.
          </button>
          <button onclick="trySample(this)">
            What was the district with the highest rice production in West
            Bengal in the most recent year?
          </button>
          <button onclick="trySample(this)">
            Analyze the production trend of Wheat in Punjab over the last 5
            years and correlate it with rainfall data.
          </button>
        </div>
      </div>

      <form id="chat-form">
        <input
          type="text"
          id="chat-input"
          placeholder="Ask a question..."
          autocomplete="off"
        />
        <button type="submit" id="send-button">Send</button>
      </form>
    </div>

    <script>
      const chatHistory = document.getElementById("chat-history");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");

      // --- Gemini API Configuration ---
      // IMPORTANT: In a real-world app, the API key is not hardcoded.
      // We leave it as "" here, as the environment will provide it.
      const apiKey = "AIzaSyANrJw3rKZUDliadXRRLdNAyc4T64gc9GE";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      // The System Prompt that defines the "Intelligent Agent"
      const systemInstruction = {
        parts: [
          {
            text:
              "You are 'Project Samarth,' an expert data analyst for the Indian government. Your mission is to answer complex questions about India's agricultural economy and climate." +
              "You MUST source your information by searching the live `data.gov.in` portal. Use the 'google_search' tool provided." +
              "Your answers must be accurate, synthesize data from multiple sources (like agriculture and meteorology), and be data-backed." +
              "CRITICAL: For every data point or claim you make, you MUST cite the source from the grounding metadata. Your response will be parsed to show these citations." +
              "When asked to 'compare' or 'analyze,' present data clearly. You must explicitly state which ministry's data you are using (e.g., 'According to the Ministry of Agriculture & Farmers Welfare...')." +
              "If you cannot find specific data after searching, clearly state that the data for that specific query (e.g., 'Crop_Z in State_X for 2023') is not available in the search results." +
              "ALWAYS try to find data from 'data.gov.in' first. Your searches should be targeted, e.g., 'annual rainfall maharashtra data.gov.in', 'district wise crop production west bengal data.gov.in'.",
          },
        ],
      };

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const userQuery = chatInput.value.trim();
        if (userQuery) {
          addMessage(userQuery, "user");
          chatInput.value = "";
          handleSubmit(userQuery);
        }
      });

      function trySample(button) {
        const query = button.innerText;
        chatInput.value = query;
        addMessage(query, "user");
        handleSubmit(query);
      }

      function addMessage(text, sender, citations = []) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add(
          "message",
          sender === "user" ? "user-message" : "bot-message"
        );

        // Sanitize text before adding
        const textNode = document.createElement("div");
        textNode.innerHTML = text.replace(/\n/g, "<br>"); // Basic formatting
        messageDiv.appendChild(textNode);

        if (citations.length > 0) {
          const citationsDiv = document.createElement("div");
          citationsDiv.classList.add("citations");

          const titleDiv = document.createElement("div");
          titleDiv.classList.add("citations-title");
          titleDiv.innerText = "Sources (from data.gov.in):";
          citationsDiv.appendChild(titleDiv);

          citations.forEach((source) => {
            const link = document.createElement("a");
            link.href = source.uri;
            link.title = source.title;
            link.innerText = source.title || source.uri;
            link.target = "_blank";
            link.classList.add("citation-link");
            citationsDiv.appendChild(link);
          });
          messageDiv.appendChild(citationsDiv);
        }

        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      function showLoading() {
        const loadingDiv = document.createElement("div");
        loadingDiv.classList.add("message", "bot-message", "loading-dots");
        loadingDiv.id = "loading";
        loadingDiv.innerHTML = "<span></span><span></span><span></span>";
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      function removeLoading() {
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }

      async function handleSubmit(userQuery) {
        sendButton.disabled = true;
        chatInput.disabled = true;
        showLoading();

        try {
          const { text, sources } = await callGeminiAPI(userQuery);
          removeLoading();
          addMessage(text, "bot", sources);
        } catch (error) {
          removeLoading();
          console.error("API Error:", error);
          addMessage(
            `Sorry, I encountered an error trying to process that: ${error.message}. Please check the console.`,
            "bot"
          );
        }

        sendButton.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }

      async function callGeminiAPI(userQuery, retries = 3, delay = 1000) {
        // Construct the payload
        const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          tools: [{ google_search: {} }], // Enable Google Search grounding
          systemInstruction: systemInstruction,
        };

        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error(
                `API responded with status: ${response.status} ${response.statusText}`
              );
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
              // 1. Extract the generated text
              const text = candidate.content.parts[0].text;

              // 2. Extract grounding sources
              let sources = [];
              const groundingMetadata = candidate.groundingMetadata;
              if (
                groundingMetadata &&
                groundingMetadata.groundingAttributions
              ) {
                sources = groundingMetadata.groundingAttributions
                  .map((attribution) => ({
                    uri: attribution.web?.uri,
                    title: attribution.web?.title,
                  }))
                  .filter(
                    (source) =>
                      source.uri &&
                      source.title &&
                      source.uri.includes("data.gov.in")
                  ); // Filter for data.gov.in
              }

              // Deduplicate sources based on URI
              const uniqueSources = Array.from(
                new Map(sources.map((s) => [s.uri, s])).values()
              );

              return { text, sources: uniqueSources };
            } else {
              throw new Error("Invalid response structure from API.");
            }
          } catch (error) {
            console.warn(
              `Attempt ${i + 1} failed. Retrying in ${delay}ms...`,
              error
            );
            if (i === retries - 1) throw error; // Re-throw last error
            await new Promise((res) => setTimeout(res, delay));
            delay *= 2; // Exponential backoff
          }
        }
      }
    </script>
  </body>
</html>
